<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        ul, #myUL {
          list-style-type: none;
        }

        #myUL {
          margin: 0;
          padding: 0;
        }

        .caret {
          cursor: pointer;
          -webkit-user-select: none; /* Safari 3.1+ */
          -moz-user-select: none; /* Firefox 2+ */
          -ms-user-select: none; /* IE 10+ */
          user-select: none;
        }

        .caret::before {
          content: "\25B6";
          color: black;
          display: inline-block;
          margin-right: 6px;
        }

        .caret-down::before {
          -ms-transform: rotate(90deg); /* IE 9 */
          -webkit-transform: rotate(90deg); /* Safari */
          transform: rotate(90deg);  
        }

        .nested {
          display: none;
        }

        .active {
          display: block;
        }
    </style>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    
    
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>


    <title>Hello, world!</title>
</head>

<body>
  <!-- Add Folder -->
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@add_folder">Add Folder</button>
  
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">New message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="add_folder_form">
            <div class="mb-3">
              <label for="recipient-name" class="col-form-label">Recipient:</label>
              <input type="text" class="form-control" id="recipient-name">
            </div>
            <div class="mb-3">
              <label for="message-text" class="col-form-label">Message:</label>
              <textarea class="form-control" id="message-text"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="add_folder">Add</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Files -->

  <div class="modal fade" id="exampleModal_file" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">New message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="add_file_form">
            <div class="mb-3">
              <label for="recipient-name" class="col-form-label">Recipient:</label>
              <input type="text" class="form-control" id="recipient-name">
            </div>
            <div class="mb-3">
              <label for="folder-path" class="col-form-label">Folder Path:</label>
              <input type="text" class="form-control" id="folder-path">
            </div>
            <div class="mb-3">
              <label for="message-text" class="col-form-label">Message:</label>
              <textarea class="form-control" id="message-text-file"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="add_file">Add</button>
        </div>
      </div>
    </div>
  </div>

<!-- Modal -->
<div class="modal fade" id="exampleModal_delete" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body">
      </div>
      <div class="mb-3">
        <label for="delete-folder" class="col-form-label">Confirmation statement</label>
        <input type="text" class="form-control" id="delete-folder" placeholder="delete">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="delete-button">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Script list -->
<ul id="myUL"></ul>

    <script>
        var exampleModal_add_folder = document.getElementById('exampleModal')
        exampleModal_add_folder.addEventListener('show.bs.modal', function (event) {
          // Button that triggered the modal
          var button = event.relatedTarget
          // Extract info from data-bs-* attributes
          var recipient = button.getAttribute('data-bs-whatever')
          // If necessary, you could initiate an AJAX request here
          // and then do the updating in a callback.
          //
          // Update the modal's content.
          var modalTitle = exampleModal_add_folder.querySelector('.modal-title')
          var modalBodyInput = exampleModal_add_folder.querySelector('#recipient-name')

          modalTitle.textContent = 'New message to ' + recipient
          modalBodyInput.value = recipient
        })


        var exampleModal_file = document.getElementById('exampleModal_file')
        exampleModal_file.addEventListener('show.bs.modal', function (event) {
          // Button that triggered the modal
          var button = event.relatedTarget
          // Extract info from data-bs-* attributes
          var recipient = button.getAttribute('data-bs-whatever')
          var folder_path = button.getAttribute('data-folder-name')
          // If necessary, you could initiate an AJAX request here
          // and then do the updating in a callback.
          //
          // Update the modal's content.
          var modalTitle = exampleModal_file.querySelector('.modal-title')
          var modalBodyInput = exampleModal_file.querySelector('.modal-body input')
          var modalAddFileInput = exampleModal_file.querySelector('#folder-path')

          modalTitle.textContent = 'New message to ' + recipient
          modalBodyInput.value = recipient
          modalAddFileInput.value = folder_path
        })


        var exampleModal_delete_folder = document.getElementById('exampleModal_delete')
        exampleModal_delete_folder.addEventListener('show.bs.modal', function (event) {
          // Button that triggered the modal
          var button = event.relatedTarget
          var content_type = button.getAttribute("content-type")
          if(content_type === "folder"){
            // Extract info from data-bs-* attributes
            var recipient = button.getAttribute('data-folder-path')
            // If necessary, you could initiate an AJAX request here
            // and then do the updating in a callback.
            //
            // Update the modal's content.
            var modalTitle = exampleModal_delete_folder.querySelector('.modal-title')
            var modalBody = exampleModal_delete_folder.querySelector('#modal-body')
            var modalDeleteButton = exampleModal_delete_folder.querySelector('#delete-button')

            modalTitle.textContent = 'New message to ' + recipient
            modalBody.innerHTML = "Delete " + recipient
            modalDeleteButton.setAttribute("content-type","folder")
            modalDeleteButton.setAttribute("button-folder-path",recipient)
            // modalBodyInput.value = recipient
          } else if (content_type === "file"){
            // Extract info from data-bs-* attributes
            var folder_path = button.getAttribute('data-folder-path')
            var file_name = button.getAttribute('data-file-name')
            // If necessary, you could initiate an AJAX request here
            // and then do the updating in a callback.
            //
            // Update the modal's content.
            var modalTitle = exampleModal_delete_folder.querySelector('.modal-title')
            var modalBody = exampleModal_delete_folder.querySelector('#modal-body')
            var modalDeleteButton = exampleModal_delete_folder.querySelector('#delete-button')

            modalTitle.textContent = 'Folder Path ' + folder_path 
            modalBody.innerHTML = "Delete " + file_name
            modalDeleteButton.setAttribute("content-type","file")
            modalDeleteButton.setAttribute("button-file-name",file_name)
            modalDeleteButton.setAttribute("button-folder-path",folder_path)
            // modalBodyInput.value = recipient
          }
  
        })




        
        document.getElementById("delete-button").addEventListener("click", function() {
          var confirm_statement = document.getElementById("delete-folder").value;
          
          var contentType = document.getElementById('delete-button').getAttribute('content-type')
          if(contentType === "folder"){
            var folderName = document.getElementById('delete-button').getAttribute('button-folder-path')
            console.log(confirm_statement)
            if(confirm_statement === 'delete'){
                $.post("/api/script_builder/delete/folder/",
                {
                    "folder_name" : folderName
                },
                function(data,status){
                    try {
                        // output = JSON.parse(data)
                        console.log('Test Results :- \n',data)
                        // addToOutput(output);
                    } catch (err) {
                        addToOutput(err);
                    }
                    console.log("Data: " + data + "\nStatus: " + status);
                  });
                window.location.reload();
              }
              else{
                console.log("Please check the Confirmation statement")
              }
          } else if (contentType === "file"){
            var folderName = document.getElementById('delete-button').getAttribute('button-folder-path')
            var fileName = document.getElementById('delete-button').getAttribute('button-file-name')
            console.log(fileName)
            if(confirm_statement === 'delete'){
              $.post("/api/script_builder/delete/file/",
              {
                "dir_path" : folderName,
                "file_name" : fileName
              },
              function(data,status){
                  try {
                      // output = JSON.parse(data)
                      console.log('Test Results :- \n',data)
                      // addToOutput(output);
                  } catch (err) {
                      addToOutput(err);
                  }
                  console.log("Data: " + data + "\nStatus: " + status);
                });
              window.location.reload();
            }
            else{
              console.log("Please check the Confirmation statement")
            }
          }
          
        });


        const form  = document.getElementById('add_folder_form');
        document.getElementById("add_folder").addEventListener("click", function() {
          var folderName = document.getElementById("message-text").value;
          console.log(folderName)
          $.post("/api/script_builder/add/folder/",
          {
              "folder_name" : folderName
          },
          function(data,status){
              try {
                  // output = JSON.parse(data)
                  console.log('Test Results :- \n',data)
                  // addToOutput(output);
              } catch (err) {
                  addToOutput(err);
              }
              console.log("Data: " + data + "\nStatus: " + status);
            });
          window.location.reload();
        });

        const form_file  = document.getElementById('add_file_form');
        document.getElementById("add_file").addEventListener("click", function() {
          var folder_path = document.getElementById("folder-path").value;
          var filename = document.getElementById("message-text-file").value;
          console.log(filename)
          $.post("/api/script_builder/add/file/",
          {
              "dir_path" : folder_path,
              "file_name" : filename
          },
          function(data,status){
              try {
                  // output = JSON.parse(data)
                  console.log('Test Results :- \n',data)
                  // addToOutput(output);
              } catch (err) {
                  addToOutput(err);
              }
              console.log("Data: " + data + "\nStatus: " + status);
            });
            location.href = `/api/scripts/?dir_path=${folder_path}&file_path=${filename}`
        });




        /*
            tree directory view for scripts 
            https://www.w3schools.com/howto/howto_js_treeview.asp
        */
        function toggle_tree_view(){
            var toggler = document.getElementsByClassName("caret");
            var i;

            for (i=0; i < toggler.length; i++) {
              console.log(toggler[i])
              toggler[i].addEventListener("click", function() {
                this.parentElement.querySelector(".nested").classList.toggle("active");
                this.classList.toggle("caret-down");
              });
            }
        }

        const makeRequest = (method, url, data = {}) => {
          const xhr = new XMLHttpRequest();
          return new Promise(resolve => {
            xhr.open(method, url, true);
            xhr.onload = () => resolve({
              status: xhr.status,
              response: xhr.responseText
            });
            xhr.onerror = () => resolve({
              status: xhr.status,
              response: xhr.responseText
            });
            if (method != 'GET') xhr.setRequestHeader('Content-Type', 'application/json');
            data != {} ? xhr.send(JSON.stringify(data)) : xhr.send();
          })
        }


        async function addData(){
            let request = await makeRequest('GET', `/api/script_builder/upload/list/`);
            console.log("status:", request.status)
            console.log("response:", request.response)
            var data = JSON.parse(request.response).dir_list;

            base_url = window.location.origin;
            for(var key in data){
                var tree_ul = ""
                if (data.hasOwnProperty(key)){
                    var value=data[key];
                    // console.log(key,value)
                    var tree_view_list = ""
                    for(j=0; j<value.length; j++){
                        var link = new URL(`/api/scripts/`, base_url);
                        link.searchParams.append('dir_path', key);
                        link.searchParams.append('file_path', value[j]);
                        link = link.href
                        console.log(link)

                        console.log(`<li>${value[j]}</li>`)
                        var tree_view_list = tree_view_list + `<a href="${link}"><li>${value[j]}</li></a><button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal_delete" data-folder-path="${key}" data-file-name="${value[j]}" content-type="file"> Delete File (${value[j]})</button>  `
                    }  
                }
                tree_ul = `<li>
                              <span class="caret">
                                ${key}
                              </span>
                              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal_file" data-bs-whatever="@getbootstrap" data-folder-name=${key}>Add File</button>
                              <!-- Button trigger modal -->
                              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal_delete" data-folder-path="${key}" content-type="folder">
                                Delete Folder (${key})
                              </button>  
                              <ul class="nested">
                                  ${tree_view_list}
                                </ul>   
                            </li>`
                document.getElementById('myUL').innerHTML += tree_ul
                toggle_tree_view()
                

            }
        }

    window.addEventListener('load', (event) => {
        console.log('page is fully loaded');
        /* 
            https://stackoverflow.com/questions/48969495/in-javascript-how-do-i-should-i-use-async-await-with-xmlhttprequest
        */

        addData()  
    });

    </script>

</body>

</html>